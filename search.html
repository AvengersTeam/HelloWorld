<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Hello World index page">
  <meta name="author" content="Avengers Team">
  <title>Proyecto de Juguete</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
  <link rel="stylesheet" href="style.css">
  <script src="http://code.jquery.com/jquery-1.11.2.min.js" type="text/javascript"></script>
  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="header clearfix">
        <nav>
          <ul class="nav nav-pills pull-right">
            <li role="presentation"><a href="index.html">Basics</a></li>
            <li role="presentation"><a href="rdf.html">RDF Database</a></li>
            <li role="presentation" class="active"><a href="search.html">Buscador</a></li>
            <li role="presentation"><a href="contact.html">Contact</a></li>
          </ul>
        </nav>
        <h3 class="text-muted">HelloWorld!</h3>
      </div>
      <div class="body">
        <h1 class="page-header">Buscador de Datos</h1>

        <p>Busca en <a href="http://dbpedia.org/sparql"> DBPedia </a>!</p>

        <form class="form-inline" action="javascript:doSubjectQuery()">
          <div class="form-group">
            <input type="text" class="form-control" id="subject" placeholder="Buscar por sujeto...">
          </div>
          <button type="submit" class="btn btn-default"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
        </form>

        <div id="subject-table"></div>

        <form class="form-inline" action="javascript:doPredicateQuery()">
          <div class="form-group">
            <input type="text" class="form-control" id="predicate" placeholder="Buscar por predicado...">
          </div>
          <button type="submit" class="btn btn-default"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
        </form>

        <div id="predicate-table"></div>

        <form class="form-inline" action="javascript:doObjectQuery()">
          <div class="form-group">
            <input type="text" class="form-control" id="object" placeholder="Buscar por objeto...">
          </div>
          <button type="submit" class="btn btn-default"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
        </form>

        <div id="object-table"></div>

      </div>
    </div>

    <script type="text/javascript">

      function doSubjectQuery() { 
        var value = $("#subject").val();
        var q = 'SELECT DISTINCT ?Subject ?Predicate ?Object WHERE { ?Subject ?Predicate ?Object . FILTER regex(str(?Subject), "'+ value +'", "i" ) } LIMIT 10';
        var t = setTimeout(doQuery(q,'#subject-table'), 10000);
      }

      function doPredicateQuery() { 
        var value = $("#predicate").val();
        var q = 'SELECT DISTINCT ?Subject ?Predicate ?Object WHERE { ?Subject ?Predicate ?Object . FILTER regex(str(?Predicate), "'+ value +'", "i" ) } LIMIT 10';
        setTimeout(doQuery(q,'#predicate-table'), 10000);
      }

      function doObjectQuery() { 
        var value = $("#object").val();
        var q = 'SELECT DISTINCT ?Subject ?Predicate ?Object WHERE { ?Subject ?Predicate ?Object . FILTER regex(?Object, "'+ value +'", "i" ) } LIMIT 10';
        setTimeout(doQuery(q,'#object-table'), 10000);
      }

      function doQuery(q,resContainerId) {
        var prefixs = {
          cd: 'PREFIX cd: <http://www.recshop.fake/cd#>',
          rdf: 'PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>',
          dbpediaowl: 'PREFIX dbpedia-owl: <http://dbpedia.org/ontology/>',
          dbpediares: 'PREFIX dbpedia-res: <http://dbpedia.org/resource/>',
        };

        var prefix = prefixs.cd + prefixs.rdf + prefixs.dbpediaowl + prefixs.dbpediares;
        //var url = 'http://localhost:8080/openrdf-sesame/repositories/test';
        var url = 'http://dbpedia.org/sparql';

        $.ajax({ 
          dataType: 'jsonp',
          data: {
            //queryLn: 'SPARQL',
            query: prefix  + q,
            format: 'application/sparql-results+json',
            //infer: 'true',
            //Accept: 'application/sparql-results+json' // Si pongo format en vez de Accept se enoja
          },
          url: url,
          success: function( data ) {
            var table = '<table class="table table-condensed table-bordered"><thead><tr>';
            var props = [];
            $( data.head.vars ).each( function( k, v ) {
              props.push( v );
              table += '<th>' + v + '</th>';
            });
            table += '</tr></thead><tbody>';
            $( data.results.bindings ).each( function( k, v ) {
              table += '<tr>';
              $( props ).each( function ( i, it ) { 
                table += '<td><a href="' + v[it].value + '">' + v[it].value + '</a></td>'; 
              } );
              table += '</tr>';  
            });
            if( data.results.bindings.length == 0 ) { console.log('missing?'); table += '<tr><td colspan="'+props.length+'" class="text-center">Sin Resultados</td></tr>';}
            $( resContainerId ).empty().append( table );
          },
          complete: function() {
            console.log( 'Query Complete!' );
          }
        });
}

</script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
</body>
</html>
